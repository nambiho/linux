# Domino Server Stop Script
# Licenced Materials - Property of IBM
# (C) COPYRIGHT International Business Machines Corp 1994,2009
# All Rights Reserved.
# US Government Users Restricted Rights - Use, duplication or disclosure
# restricted by GSA ADP Schedule Contract with IBM Corp.
############################################################################ 
#
# This is the script to STOP the Domino Server which has been started using
# the corresponding script (start_ dwep01).
# The script attempts to QUIT the server gracefully and waits
#
# If Domino Server has not shut down by then, it will be killed.
# Depending on your environment, you may want to change this time-out
# period.
#
# Make sure the correct environment script is called on the first line below
# It should call the environment script that is specific to the Domino server
# this script is being used to control
#
############################################################################ 

# This script is provided "As Is".
#
# Set Script Environment variables.

NOTES_USER=notes				# AIX user id for this server   
NOTES_PATH=/hdd/ext1/notesdata  		        # Path for server data directory	
NOTES_SERVER=wing				# Name of Domino Server
LOTUS_PATH=/opt/hcl/domino 	                # Program folder of server
OUTPUT_LOG=$NOTES_PATH/log/$NOTES_SERVER.log	# Output file for server console
INPUT_FILE=$NOTES_PATH/$NOTES_USER.input		# Input file for server console

CURDATE=`date +"%m%d%H%M"`
PATH=$NOTES_PATH:$LOTUS_PATH/bin:$HOME/bin:$PATH



# Script Logic
echo "TCCINS Stopping Domino for Linux ($NOTES_SERVER)"
echo " ... waiting 2 minutes for shutdown to complete"
# write the quit command to servers input file
echo " quit " >> $INPUT_FILE
#
count=0
NOTES_RUNNING=`ps -fu $NOTES_USER | grep $LOTUS_PATH | grep -v grep `
while [[ -n $NOTES_RUNNING ]] ; do
sleep 10
count=`expr $count + 1`
echo " ... waiting "$count"0 seconds"
echo " ... waiting "$count"0 seconds"
#
# Terminate Domino Server if still running
#
if [ $count -eq 13 ] ; then
echo "Domino Server is still running after 2 minutes"
echo " ... now forcing shutdown via NSD -kill"
sleep 5
cd $NOTES_PATH
nsd -user $NOTES_USER -kill
mems=`ipcs | grep $NOTES_USER | awk '{ print $1 $2 }' | awk -F"m" '{
print $2 }' | awk '{ print $1 }'`
sems=`ipcs | grep $NOTES_USER | awk '{ print $1 $2 }' | awk -F"s" '{
print $2 }' | awk '{ print $1 }'`
  for j in $mems;do if [ -n "$j" ] ; then ipcrm -m $j;fi;done

   for j in $sems;do if [ -n "$j" ] ; then ipcrm -s $j;fi;done
  sleep 5
  echo ""
  echo "Domino Server ($NOTES_SERVER) did not shut down gracefully - TERMINATED!"
  echo ""

# Reset to the servers input file to blank
  echo " " > $INPUT_FILE
  exit
fi
NOTES_RUNNING=`ps -fu $NOTES_USER | grep $LOTUS_PATH | grep -v grep `
done
#
echo "Shutdown of Domino Server ($NOTES_SERVER) completed gracefully"
# reset the servers input file to blank
echo " " > $INPUT_FILE
